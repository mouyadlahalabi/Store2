{% extends 'base.html' %}
{% load static %}

{% block title %}الرئيسية - نظام إدارة المستخدمين{% endblock %}

{% block content %}
<style>
    :root {
        --beige-light: #F5E6D3;
        --beige-medium: #E8D5C4;
        --beige-dark: #D4C4B0;
        --beige-darker: #C4B5A0;
        --olive-dark: #556B2F;
        --olive-medium: #6B8E23;
        --olive-light: #7A8B5A;
        --olive-lighter: #8F9779;
        --olive-accent: #9CAF88;
    }
    
    .store-products-section {
        background: linear-gradient(135deg, var(--olive-dark) 0%, var(--olive-medium) 50%, var(--olive-light) 100%);
        padding: 3rem 0;
        margin-bottom: 3rem;
        border-radius: 0 0 30px 30px;
        box-shadow: 0 5px 20px rgba(85, 107, 47, 0.2);
    }
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }
    .product-card {
        background: var(--beige-medium);
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
        box-shadow: 0 5px 15px rgba(85, 107, 47, 0.15);
        height: 100%;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--olive-light);
    }
    .product-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 25px rgba(85, 107, 47, 0.25);
        text-decoration: none;
        color: inherit;
        border-color: var(--olive-medium);
    }
    .store-name-header {
        background: linear-gradient(135deg, var(--olive-dark) 0%, var(--olive-medium) 100%);
        color: white;
        padding: 0.75rem 1rem;
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .favorite-btn-small {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s ease;
        padding: 0.2rem 0.5rem;
        border-radius: 5px;
        font-size: 1.2rem;
    }
    
    .favorite-btn-small:hover {
        color: #ff6b6b;
        background: rgba(255, 255, 255, 0.2);
        text-decoration: none;
    }
    
    .favorite-btn-small.active {
        color: #ff6b6b;
    }
    .store-name-header i {
        font-size: 1.1rem;
    }
    .product-image-container {
        width: 100%;
        height: 200px;
        overflow: hidden;
        background: var(--beige-light);
        position: relative;
    }
    .product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    .product-card:hover .product-image {
        transform: scale(1.1);
    }
    .product-info {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .product-name {
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: var(--olive-dark);
        line-height: 1.4;
        min-height: 2.8rem;
    }
    .product-description {
        font-size: 0.85rem;
        color: #5a5a5a;
        margin: 0 0 0.75rem 0;
        line-height: 1.5;
        flex-grow: 1;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .product-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        padding-top: 0.75rem;
        border-top: 1px solid var(--olive-light);
    }
    .product-price {
        font-size: 1.1rem;
        color: var(--olive-dark);
        font-weight: 700;
        margin: 0;
    }
    .product-stock {
        font-size: 0.8rem;
        color: var(--olive-medium);
        font-weight: 500;
    }
    .section-title {
        color: white;
        text-align: center;
        margin-bottom: 2rem;
        font-size: 2rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .no-image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--beige-light) 0%, var(--beige-medium) 100%);
    }
    .no-image-placeholder i {
        font-size: 4rem;
        color: var(--olive-lighter);
    }
    .product-image-container {
        cursor: pointer;
    }
    .product-image-container:has(.no-image-placeholder) {
        cursor: default;
    }
    /* Modal للصورة */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        animation: fadeIn 0.3s;
    }
    .image-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        max-width: 90%;
        max-height: 90%;
        margin: auto;
        animation: zoomIn 0.3s;
    }
    .modal-content img {
        width: 100%;
        height: auto;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 10px;
    }
    .close-modal {
        position: absolute;
        top: 20px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
    }
    .close-modal:hover {
        color: #fff;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes zoomIn {
        from { transform: scale(0.7); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
</style>

<!-- قسم المنتجات العشوائية من كل متجر -->
{% if store_products %}
<div class="store-products-section">
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="section-title mb-0">
                    <i class="bi bi-star-fill"></i> منتجات مميزة من متاجرنا
                </h2>
            </div>
            <div class="col-md-4">
                <form method="GET" class="d-flex">
                    <select name="store" class="form-select" onchange="this.form.submit()" style="background: white; border: 2px solid rgba(255,255,255,0.3); color: var(--olive-dark);">
                        <option value="">جميع المتاجر</option>
                        {% for store in all_stores %}
                        <option value="{{ store.id }}" {% if selected_store == store.id %}selected{% endif %}>
                            {{ store.name }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>
        
        <div class="products-grid">
            {% for item in store_products %}
                {% with store=item.store products=item.products %}
                    {% for product in products %}
                        <div class="product-card">
                            <!-- اسم المتجر في الأعلى -->
                            <div class="store-name-header">
                                <div class="d-flex justify-content-between align-items-center w-100">
                                    <div>
                                        <i class="bi bi-shop"></i>
                                        {{ store.name }}
                                    </div>
                                    {% if user.is_authenticated and not user.is_store_owner %}
                                        <a href="{% url 'stores:toggle_favorite_store' store.id %}" 
                                           class="favorite-btn-small {% if store.id in favorite_store_ids %}active{% endif %}" 
                                           title="{% if store.id in favorite_store_ids %}إزالة من المفضلة{% else %}إضافة إلى المفضلة{% endif %}"
                                           onclick="event.preventDefault(); toggleFavorite(this, {{ store.id }});">
                                            <i class="bi {% if store.id in favorite_store_ids %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- صورة المنتج -->
                            <div class="product-image-container" {% if product.image %}onclick="openImageModal('{{ product.image.url }}', '{{ product.name }}')"{% endif %}>
                                {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
                                {% else %}
                                    <div class="no-image-placeholder" style="cursor: default;">
                                        <i class="bi bi-image"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- تفاصيل المنتج -->
                            <div class="product-info">
                                <h5 class="product-name">{{ product.name }}</h5>
                                {% if product.description %}
                                    <p class="product-description">{{ product.description|truncatewords:15 }}</p>
                                {% endif %}
                                
                                <div class="product-details">
                                    <span class="product-price">{{ product.price }} ر.س</span>
                                    {% if product.stock > 0 %}
                                        <span class="product-stock">
                                            <i class="bi bi-check-circle"></i> متوفر ({{ product.stock }})
                                        </span>
                                    {% else %}
                                        <span class="product-stock" style="color: #8B4513;">
                                            <i class="bi bi-x-circle"></i> غير متوفر
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endwith %}
            {% endfor %}
        </div>
        
        <!-- Modal لعرض الصورة -->
        <div id="imageModal" class="image-modal" onclick="closeImageModal()">
            <span class="close-modal" onclick="closeImageModal()">&times;</span>
            <div class="modal-content" onclick="event.stopPropagation()">
                <img id="modalImage" src="" alt="">
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- قسم قائمة المتاجر (اختياري - يمكن إزالته إذا لم تكن هناك حاجة) -->
<div class="container mt-5">
    <h2 class="text-center mb-5" style="color: var(--olive-dark);"><i class="bi bi-shop"></i> جميع المتاجر المتاحة</h2>
    
    {% if store_products %}
        <div class="row">
            {% for item in store_products %}
                {% with store=item.store %}
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100">
                        {% if store.logo %}
                            <img src="{{ store.logo.url }}" class="card-img-top" alt="{{ store.name }}" style="height: 200px; object-fit: cover;">
                        {% else %}
                            <img src="https://via.placeholder.com/400x200?text=Store+Logo" class="card-img-top" alt="No logo">
                        {% endif %}

                        <div class="card-body text-center">
                            <h5 class="card-title">{{ store.name }}</h5>
                            <p class="text-muted">{{ store.description|truncatechars:80 }}</p>
                            <p><strong>المالك:</strong> {{ store.owner.username }}</p>
                        </div>

                        <div class="card-footer text-center" style="background: var(--beige-light);">
                            <a href="{% url 'stores:store_front' store.id %}" class="btn btn-outline-primary btn-sm me-2">
                                <i class="bi bi-grid-3x3-gap"></i> عرض الأقسام
                            </a>

                            {% if user.is_authenticated %}
                                {% if user == store.owner or user.is_superuser %}
                                    <form method="post" action="{% url 'stores:store_delete' store.id %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-danger btn-sm"
                                            onclick="return confirm('هل أنت متأكد من حذف هذا المتجر؟');">
                                            <i class="bi bi-trash"></i> حذف
                                        </button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endwith %}
            {% endfor %}
        </div>
    {% else %}
        <p class="text-center text-muted">لا توجد متاجر حالياً.</p>
    {% endif %}
</div>

<script>
    function openImageModal(imageUrl, productName) {
        if (!imageUrl || imageUrl === '') {
            return; // لا تفتح الـ modal إذا لم تكن هناك صورة
        }
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        modalImg.src = imageUrl;
        modalImg.alt = productName;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // منع التمرير عند فتح الـ modal
    }
    
    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto'; // إعادة التمرير
    }
    
    // إغلاق الـ modal عند الضغط على زر ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });
    
    // دالة إضافة/حذف من المفضلة
    function toggleFavorite(btn, storeId) {
        fetch(`/store/toggle-favorite/${storeId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            const icon = btn.querySelector('i');
            if (data.is_favorite) {
                btn.classList.add('active');
                icon.classList.remove('bi-heart');
                icon.classList.add('bi-heart-fill');
                btn.title = 'إزالة من المفضلة';
            } else {
                btn.classList.remove('active');
                icon.classList.remove('bi-heart-fill');
                icon.classList.add('bi-heart');
                btn.title = 'إضافة إلى المفضلة';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Fallback to normal redirect
            window.location.href = btn.href;
        });
    }
</script>
{% endblock %}
